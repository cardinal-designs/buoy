{% assign isMainBundleProduct = item.properties._bundle_parent %}
{% assign subProductKeys = blank %}
{% assign bundeOriginal_price = 0 %}
{% assign bundeFinal_price = 0 %}
{% if isMainBundleProduct != blank %}
  {% for line_item in cart.items %}
    {% assign subBundleId = line_item.properties._bundle_id | split:'|' %}
    {% if subBundleId[0] == item.properties._bundle_id and line_item.properties._bundle_parent == blank %}
      {% assign original_price = line_item.original_price | times:line_item.quantity %}
      {% assign final_price = line_item.final_price | times:line_item.quantity %}
      {% assign bundeOriginal_price = bundeOriginal_price | plus:original_price %}
      {% assign bundeFinal_price = bundeFinal_price | plus:final_prices %}
      {% assign UpdateData = line_item.key | append:'|' | append:subBundleId[1] | append:'|' | append:line_item.product.title %}
      {% assign subProductKeys = subProductKeys | append:',' | append:UpdateData %}
    {% endif %}
  {% endfor %}
{% endif %}
{% assign mainUpdateData = item.key | append:'|' | append:item.quantity %}
<div class="cart-drawer__item" {% if subProductKeys != blank %} data-bundle-items='{{ subProductKeys | append:'==' | append:mainUpdateData  | remove_first:',' }}'{% endif %}>
  <cart-drawer-remove-button id="Remove-{{ item.index | plus: 1 }}" data-index="{{ item.index | plus: 1 }}">
    <a href="{{ item.url_to_remove }}" class="cart-drawer__item-remove body-xs" aria-label="{{ 'sections.cart.remove_title' | t: title: item.title }}">
      {% comment %}{% render 'icon-trash' %}{% endcomment %}
      Remove
    </a>
  </cart-drawer-remove-button>

  <div class="cart-drawer__item-image-wrapper">
    {% if item.image %}
      <img class="cart-drawer__item-image img-fill"
        src="{{ item.image | img_url: '150x' }}"
        alt="{{ item.image.alt | escape }}"
        loading="lazy"
        width="120"
        height="{{ 120 | divided_by: item.image.aspect_ratio | ceil }}"
      >
    {% endif %}
  </div>
  <div class="cart-drawer__item-content">

    <h4 class="cart-drawer__item-title sh3">{{ item.product.title }}</h4>

    <div class="cart-drawer__item-price sh4">
      {% if isMainBundleProduct != blank %}
        {% if bundeOriginal_price != bundeFinal_price %}
        <dl class="cart-item__discounted-prices">
          <dd>
            <s class="cart-item__old-price price price--end">
              {{ bundeOriginal_price | money }}
            </s>
          </dd>
          <dt class="visually-hidden">
            {{ 'products.product.price.sale_price' | t }}
          </dt>
          <dd class="price price--end">
            {{ bundeFinal_price | money }}
          </dd>
        </dl>
        {% else %}
          <span class="price price--end">
            {{ bundeOriginal_price | money }}
          </span>
        {% endif %}
      {% else %}
        {%- if item.original_price != item.final_price -%}
          <dl class="cart-item__discounted-prices">
            <dt class="visually-hidden">
              {{ 'products.product.price.regular_price' | t }}
            </dt>
            <dd>
              <s class="cart-item__old-price price price--end">
                {{ item.original_price | money }}
              </s>
            </dd>
            <dt class="visually-hidden">
              {{ 'products.product.price.sale_price' | t }}
            </dt>
            <dd class="price price--end">
              {{ item.final_price | money }}
            </dd>
          </dl>

          {%- if item.variant.available and item.unit_price_measurement -%}
            <div class="unit-price caption">
              <span class="visually-hidden">{{ 'products.product.price.unit_price' | t }}</span>
              {{ item.variant.unit_price | money }}
              <span aria-hidden="true">/</span>
              <span class="visually-hidden">&nbsp;{{ 'accessibility.unit_price_separator' | t }}&nbsp;</span>
              {%- if item.variant.unit_price_measurement.reference_value != 1 -%}
                {{- item.variant.unit_price_measurement.reference_value -}}
              {%- endif -%}
              {{ item.variant.unit_price_measurement.reference_unit }}
            </div>
          {%- endif -%}
        {%- else -%}
          <span class="price price--end">
            {{ item.original_price | money }}
          </span>
        {%- endif -%}
      {%- endif -%}
      </div>

    {% comment %} CHANGE {% endcomment %}

    {%- if item.product.has_only_default_variant == false or item.properties.size != 0 or item.selling_plan_allocation != nil -%}
      <div class="cart-drawer__item-variant">
        {%- if item.product.has_only_default_variant == false -%}
          {%- for option in item.options_with_values -%}
            {%- unless option.name == 'Title' -%}
              <h6 style="margin-bottom: -5px;" class="cart-drawer__item-option body-xs light">
                {{ option.name }}:
                {{ option.value }}
              </h6>
            {%- endunless -%}
          {%- endfor -%}
        {%- endif -%}

        {%- for property in item.properties -%}
          {%- assign property_first_char = property.first | slice: 0 -%}
          {%- if property.last != blank and property_first_char != '_' -%}
            <h6 style="margin-bottom: -5px;" class="cart-drawer__item-option body-xs light">
              {{ property.first }}:
              {%- if property.last contains '/uploads/' -%}
                <a href="{{ property.last }}" target="_blank">
                  {{ property.last | split: '/' | last }}
                </a>
              {%- else -%}
                {{ property.last }}
              {%- endif -%}
              </h6>
          {%- endif -%}
        {%- endfor -%}
      </div>
      <p style="margin-bottom: -5px;" class="product-option cart-drawer__item-frequency body-xs light">
        {% if item.selling_plan_allocation.selling_plan %}
          {% render 'icon-calendar' %} Monthly: 
        {% elsif item.product.type == 'Subscription' or item.product.type == 'Bundle' %}
            One-Time Purchase: 
        {% endif %}

        {% if item.product.type == 'Subscription' or item.product.type == 'Bundle' %}
          3 Bottlesâ€”120 servings
        {% else %}
          {{ item.selling_plan_allocation.selling_plan.name }}
        {% endif %}
      </p>

    {%- endif -%}

    <div class="cart-drawer__item-bottom">

      <div class="cart-drawer__item-quantity">
        <quantity-input class="quantity">
          <button class="quantity__button no-js-hidden" name="minus" type="button">
            <span class="visually-hidden">{{ 'products.product.quantity.decrease' | t: product: item.product.title | escape }}</span>
            {% render 'icon-minus' %}
          </button>
          <input class="quantity__input body"
            type="number"
            name="updates[]"
            value="{{ item.quantity }}"
            min="0"
            aria-label="{{ 'products.product.quantity.input_label' | t: product: item.product.title | escape }}"
            id="Quantity-{{ item.index | plus: 1 }}"
            data-index="{{ item.index | plus: 1 }}"
          >
          <button class="quantity__button no-js-hidden" name="plus" type="button">
            <span class="visually-hidden">{{ 'products.product.quantity.increase' | t: product: item.product.title | escape }}</span>
            {% render 'icon-plus' %}
          </button>
        </quantity-input>
      </div>
    </div>
  </div>
  {% if isMainBundleProduct != blank %}
  <script type="application/json" class="item-data">
    {
      "propertest":{
        {% for prop in item.properties %}
          "{{ prop.first }}" : "{{ prop.last }}"{% unless forloop.last %},{% endunless %}
        {% endfor %}
      }
    }
  </script>
  {% endif %}
</div>